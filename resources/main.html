<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <!-- CSS -->
    <link rel="stylesheet" href="http://127.0.0.1:8080/static/main.css">
    <link rel="stylesheet" href="http://127.0.0.1:8080/static/fontawesome/css/all.css">
</head>

<body>
    <div id="mapid"></div>
    <!-- FontAwesome free attribution -->
    <script src="http://127.0.0.1:8080/static/fontawesome/attribution.js"></script>
    <script>
        //----------------------------------------------------------------------------//
        // Consts
        //----------------------------------------------------------------------------//
        const API_PATH = 'http://127.0.0.1:8080'

        //----------------------------------------------------------------------------//
        // Map initialisation
        //----------------------------------------------------------------------------//
        var leafletMap = L.map('mapid').setView([48.856, 2.352], 6.2);
        var leafletMarkersList = [];

        var apiMarkers;

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw'
        }).addTo(leafletMap);

        //----------------------------------------------------------------------------//
        // Leaflet events
        //----------------------------------------------------------------------------//
        function onMapClick(event) {
            addMarkerRequest(getAllMarkersRequest, {"latitude": event.latlng.lat.toString(), "longitude": event.latlng.lng.toString()})
        }

        leafletMap.on('click', onMapClick);

        //----------------------------------------------------------------------------//
        // Utility functions
        //----------------------------------------------------------------------------//
        function refreshMarkers() {
            // Delete existing markers
            for (leafletMarker of leafletMarkersList) {
                leafletMap.removeLayer(leafletMarker);
            }
            leafletMarkersList = [];

            for (apiMarker of apiMarkers.markers) {
                // Create marker on the map
                var marker = L.marker(L.latLng(apiMarker.latitude, apiMarker.longitude));
                leafletMarkersList.push(marker);
                marker.addTo(leafletMap);
                // Add popup to the marker
                var htmlPopup = '<h2>' + apiMarker.name + ' <i class="fas fa-cog"></i> <i class="fas fa-trash-alt"></i></h2>'
                var popup = L.popup().setContent(htmlPopup);
                marker.bindPopup(popup);
            }
        }

        //----------------------------------------------------------------------------//
        // API requests
        //----------------------------------------------------------------------------//
        // FIXME add "no-cache" header in all requests to prevent cache usage
        function getAllMarkersRequest() {
            xhrGetAllMarkers = new XMLHttpRequest();

            xhrGetAllMarkers.open('GET', API_PATH + '/markers', true);
            xhrGetAllMarkers.responseType = "json";
            xhrGetAllMarkers.onreadystatechange = getAllMarkersHandleResponse;
            xhrGetAllMarkers.send();

            // HTTP response handling
            function getAllMarkersHandleResponse() {
                if (xhrGetAllMarkers.readyState === XMLHttpRequest.DONE) {
                    if (xhrGetAllMarkers.status === 200) {
                        apiMarkers = xhrGetAllMarkers.response;
                        refreshMarkers();
                    } else {
                        alert('Request "getAllMarkers" failed with code ' + xhrGetAllMarkers.status.toString() + ' :(');
                    }
                }
            }
        }

        function getMarkerRequest(latitude, longitude) {
            xhrGetMarker = new XMLHttpRequest();

            xhrGetMarker.open('GET', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString(), true);
            xhrGetMarker.responseType = "json";
            xhrGetMarker.onreadystatechange = getMarkerHandleResponse;
            xhrGetMarker.send();

            // HTTP response handling
            function getMarkerHandleResponse() {
                if (xhrGetMarker.readyState === XMLHttpRequest.DONE) {
                    if (xhrGetMarker.status === 200) {
                        console.log(xhrGetMarker.response);
                    } else {
                        alert('Request "getMarker" failed with code ' + xhrGetMarker.status.toString() + ' :(');
                    }
                }
            }
        }

        function addMarkerRequest(callback, newMarker) {
            xhrAddMarker = new XMLHttpRequest();

            xhrAddMarker.open('PUT', API_PATH + '/marker', true);
            xhrAddMarker.setRequestHeader('Content-Type', 'application/json');
            xhrAddMarker.onreadystatechange = addMarkerHandleResponse;
            xhrAddMarker.send(JSON.stringify(newMarker));

            // HTTP response handling
            function addMarkerHandleResponse() {
                if (xhrAddMarker.readyState === XMLHttpRequest.DONE) {
                    if (xhrAddMarker.status === 200) {
                        callback();
                    } else {
                        alert('Request "addMarker" failed with code ' + xhrAddMarker.status.toString() + ' :(');
                    }
                }
            }
        }

        function editMarkerRequest(latitude, longitude) {
            xhrEditMarker = new XMLHttpRequest();

            xhrEditMarker.open('POST', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString(), true);
            xhrEditMarker.onreadystatechange = editMarkerHandleResponse;
            xhrEditMarker.send();

            // HTTP response handling
            function editMarkerHandleResponse() {
                if (xhrEditMarker.readyState === XMLHttpRequest.DONE) {
                    if (xhrEditMarker.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "editMarker" failed with code ' + xhrEditMarker.status.toString() + ' :(');
                    }
                }
            }
        }

        function deleteMarkerRequest(latitude, longitude) {
            xhrDeleteMarker = new XMLHttpRequest();

            xhrDeleteMarker.open('DELETE', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString(), true);
            xhrDeleteMarker.onreadystatechange = deleteMarkerHandleResponse;
            xhrDeleteMarker.send();

            // HTTP response handling
            function deleteMarkerHandleResponse() {
                if (xhrDeleteMarker.readyState === XMLHttpRequest.DONE) {
                    if (xhrDeleteMarker.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "deleteMarker" failed with code ' + xhrDeleteMarker.status.toString() + ' :(');
                    }
                }
            }
        }

        function addPhotoRequest(latitude, longitude) {
            // Use "multipart-form-data" header for photo upload
            // FIXME add content to the formData
            formData = new FormData();

            // Add file to HTTP request
            xhrAddPhoto = new XMLHttpRequest();

            xhrAddPhoto.open('POST', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString() + '/photo', true);
            xhrAddPhoto.onreadystatechange = addPhotoHandleResponse;
            xhrAddPhoto.send(formData);

            // HTTP response handling
            function addPhotoHandleResponse() {
                if (xhrAddPhoto.readyState === XMLHttpRequest.DONE) {
                    if (xhrAddPhoto.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "addPhoto" failed with code ' + xhrAddPhoto.status.toString() + ' :(');
                    }
                }
            }
        }

        function editPhotoRequest(latitude, longitude, photoId) {
            xhrEditPhoto = new XMLHttpRequest();

            xhrEditPhoto.open('POST', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString() + '/photo/' + photoId, true);
            xhrEditPhoto.onreadystatechange = editPhotoHandleResponse;
            xhrEditPhoto.send();

            // HTTP response handling
            function editPhotoHandleResponse() {
                if (xhrEditPhoto.readyState === XMLHttpRequest.DONE) {
                    if (xhrEditPhoto.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "editPhoto" failed with code ' + xhrEditPhoto.status.toString() + ' :(');
                    }
                }
            }
        }

        function deletePhotoRequest() {
            xhrDeletePhoto = new XMLHttpRequest();

            xhrDeletePhoto.open('DELETE', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString() + '/photo/' + photoId, true);
            xhrDeletePhoto.onreadystatechange = deletePhotoHandleResponse;
            xhrDeletePhoto.send();

            // HTTP response handling
            function deletePhotoHandleResponse() {
                if (xhrDeletePhoto.readyState === XMLHttpRequest.DONE) {
                    if (xhrDeletePhoto.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "deletePhoto" failed with code ' + xhrDeletePhoto.status.toString() + ' :(');
                    }
                }
            }
        }

        //----------------------------------------------------------------------------//
        // Web page logic
        //----------------------------------------------------------------------------//
        getAllMarkersRequest();

    </script>
</body>

</html>
