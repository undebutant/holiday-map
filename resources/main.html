<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <!-- CSS -->
    <link rel="stylesheet" href="http://127.0.0.1:8080/static/main.css">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="http://127.0.0.1:8080/static/fontawesome/css/all.css">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
</head>

<body>
    <div id="mapid"></div>
    <!-- FontAwesome free attribution -->
    <script src="http://127.0.0.1:8080/static/fontawesome/attribution.js"></script>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>
    <!-- Custom JS -->
    <script>
        //----------------------------------------------------------------------------//
        // Consts
        //----------------------------------------------------------------------------//
        const API_PATH = 'http://127.0.0.1:8080'

        //----------------------------------------------------------------------------//
        // Map initialisation
        //----------------------------------------------------------------------------//
        var leafletMap = L.map('mapid').setView([48.856, 2.352], 6.2);
        var leafletMarkersList = [];

        var apiMarkers;
        
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1,
            accessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw'
        }).addTo(leafletMap);

        //----------------------------------------------------------------------------//
        // Leaflet events
        //----------------------------------------------------------------------------//
        function onMapClick(event) {
            addMarkerRequest(getAllMarkersRequest, {"latitude": event.latlng.lat.toString(), "longitude": event.latlng.lng.toString()})
        }

        leafletMap.on('click', onMapClick);

        //----------------------------------------------------------------------------//
        // Utility functions
        //----------------------------------------------------------------------------//

        // function to set classic attributes to an element
        // Attributes must be set through a array of JS objects of form {'key''keyname','value','valuename'}
        // Unuses attributes must be set to ""
        function setAttributes(element, attributes){
            for( attribute of attributes){
                element.setAttribute(attribute.key, attribute.value);
            }
        }

        function createButtonElement(idAttribute, classAttribute, roleAttribute, onClickAttribute){
            var button=document.createElement("button");
            button.setAttribute('class',classAttribute);
            button.setAttribute('id',idAttribute);
            button.setAttribute('role',roleAttribute);
            button.setAttribute('onClick',onClickAttribute);
            return button;

        }

        function createIconElement(idAttribute,classAttribute){
            var icon=document.createElement('i');
            icon.setAttribute('id',idAttribute);
            icon.setAttribute('class',classAttribute);
            return icon;

        }

        function createTitleAndButtonsElement(apiMarker, markerIndex){

            var markerTitle = document.createElement('h3');
            markerTitle.textContent = apiMarker.name + ' ';

            // Button group div
            var buttonDiv = document.createElement('div');
            setAttributes(buttonDiv,[{'key':'class','value':'btn-group'},{'key':'role','value':'group'}]);

            // Edit button
            var editButton = createButtonElement('','btn btn-warning','','editMarker()');
            var editIcon = createIconElement('','fas fa-cog');
            editButton.append(editIcon);

            // Delete button
            var deleteButton = createButtonElement('','btn btn-danger','','deleteMarkerConfirmation('+markerIndex+')');
            var deleteIcon = createIconElement('','fas fa-trash-alt');
            deleteButton.append(deleteIcon);
          
            // APPEND ALL THE THINGS
            buttonDiv.append(editButton);
            buttonDiv.append(deleteButton);
            markerTitle.append(buttonDiv);

            return markerTitle;
        }

        function createCarrouselElement(apiMarker){
            var carouselOuterDiv = document.createElement('div');
            carouselOuterDiv.setAttribute('id', 'carousel_' + apiMarker.name);
            carouselOuterDiv.setAttribute('class', 'carousel slide');
            carouselOuterDiv.setAttribute('data-bs-ride', 'carousel');

            var carouselInnerDiv = document.createElement('div');
            carouselInnerDiv.setAttribute('class', 'carousel-inner');

            var isFirst = true;
            for (photo of apiMarker.photos) {
                var carouselItemDiv = document.createElement('div');
                if (isFirst){
                    carouselItemDiv.setAttribute('class', 'carousel-item active');
                    isFirst=false;
                }
                else{
                    carouselItemDiv.setAttribute('class', 'carousel-item');
                    isFirst=false; 
                }
                var carouselItemImg = document.createElement('img');
                carouselItemImg.setAttribute('src', API_PATH + '/photos/' + photo.fileName);
                carouselItemImg.setAttribute('class', 'd-block w-100');
                carouselItemImg.setAttribute('alt', photo.fileName);

                carouselItemDiv.append(carouselItemImg);
                carouselInnerDiv.append(carouselItemDiv);
            }

            carouselOuterDiv.append(carouselInnerDiv);

            var carouselButtonPrevious = document.createElement('button');
            carouselButtonPrevious.setAttribute('class', 'carousel-control-prev');
            carouselButtonPrevious.setAttribute('type', 'button');
            carouselButtonPrevious.setAttribute('data-bs-target', '#' + 'carousel_' + apiMarker.name);
            carouselButtonPrevious.setAttribute('data-bs-slide', 'prev');

            var carouselButtonPreviousSpanIcon = document.createElement('span');
            carouselButtonPreviousSpanIcon.setAttribute('class', 'carousel-control-prev-icon');
            carouselButtonPreviousSpanIcon.setAttribute('aria-hidden', 'true');

            var carouselButtonPreviousSpanText = document.createElement('span');
            carouselButtonPreviousSpanText.setAttribute('class', 'visually-hidden');
            carouselButtonPreviousSpanText.textContent = 'Previous';

            carouselButtonPrevious.append(carouselButtonPreviousSpanIcon);
            carouselButtonPrevious.append(carouselButtonPreviousSpanText);

            var carouselButtonNext = document.createElement('button');
            carouselButtonNext.setAttribute('class', 'carousel-control-next');
            carouselButtonNext.setAttribute('type', 'button');
            carouselButtonNext.setAttribute('data-bs-target', '#' + 'carousel_' + apiMarker.name);
            carouselButtonNext.setAttribute('data-bs-slide', 'next');

            var carouselButtonNextSpanIcon = document.createElement('span');
            carouselButtonNextSpanIcon.setAttribute('class', 'carousel-control-next-icon');
            carouselButtonNextSpanIcon.setAttribute('aria-hidden', 'true');

            var carouselButtonNextSpanText = document.createElement('span');
            carouselButtonNextSpanText.setAttribute('class', 'visually-hidden');
            carouselButtonNextSpanText.textContent = 'Next';

            carouselButtonNext.append(carouselButtonNextSpanIcon);
            carouselButtonNext.append(carouselButtonNextSpanText);

            carouselOuterDiv.append(carouselButtonPrevious);
            carouselOuterDiv.append(carouselButtonNext);
            return carouselOuterDiv;
        }

        function refreshMarkers() {
            // Delete existing markers
            for (leafletMarker of leafletMarkersList) {
                leafletMap.removeLayer(leafletMarker);
            }
            leafletMarkersList = [];

            var markerIndex = 0;
            for (apiMarker of apiMarkers.markers) {
                // Create marker on the map
                var marker = L.marker(L.latLng(apiMarker.latitude, apiMarker.longitude));
                leafletMarkersList.push(marker);
                marker.addTo(leafletMap);

                // Generate custom popup content for each marker
                var popupContent = document.createElement('div');
                popupContent.append(createTitleAndButtonsElement(apiMarker, markerIndex));
                popupContent.append(createCarrouselElement(apiMarker));

                // Create document fragment and append "popupContent" div
                var popupFragment = document.createDocumentFragment();
                popupFragment.appendChild(popupContent);
                var popup = L.popup().setContent(popupFragment);
                marker.bindPopup(popup, {minWidth:300, maxHeight:600} );

                markerIndex++;
            }
        }

        function editMarker() {
            console.log("Edit");
        }

        function deleteMarkerConfirmation(markerIndex) {
            targetMarker = apiMarkers.markers[markerIndex];

            isDeleting = window.confirm('Delete marker "' + targetMarker.name + '"?');
            if (isDeleting) {
                deleteMarkerRequest(getAllMarkersRequest,targetMarker.latitude, targetMarker.longitude);
                getAllMarkersRequest();
            }
        }

        //----------------------------------------------------------------------------//
        // API requests
        //----------------------------------------------------------------------------//
        // FIXME add "no-cache" header in all requests to prevent cache usage
        function getAllMarkersRequest() {
            xhrGetAllMarkers = new XMLHttpRequest();

            xhrGetAllMarkers.open('GET', API_PATH + '/markers', true);
            xhrGetAllMarkers.responseType = "json";
            xhrGetAllMarkers.onreadystatechange = getAllMarkersHandleResponse;
            xhrGetAllMarkers.send();

            // HTTP response handling
            function getAllMarkersHandleResponse() {
                if (xhrGetAllMarkers.readyState === XMLHttpRequest.DONE) {
                    if (xhrGetAllMarkers.status === 200) {
                        apiMarkers = xhrGetAllMarkers.response;
                        refreshMarkers();
                    } else {
                        alert('Request "getAllMarkers" failed with code ' + xhrGetAllMarkers.status.toString() + ' :(');
                    }
                }
            }
        }

        function getMarkerRequest(latitude, longitude) {
            xhrGetMarker = new XMLHttpRequest();

            xhrGetMarker.open('GET', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString(), true);
            xhrGetMarker.responseType = "json";
            xhrGetMarker.onreadystatechange = getMarkerHandleResponse;
            xhrGetMarker.send();

            // HTTP response handling
            function getMarkerHandleResponse() {
                if (xhrGetMarker.readyState === XMLHttpRequest.DONE) {
                    if (xhrGetMarker.status === 200) {
                        console.log(xhrGetMarker.response);
                    } else {
                        alert('Request "getMarker" failed with code ' + xhrGetMarker.status.toString() + ' :(');
                    }
                }
            }
        }

        function addMarkerRequest(callback, newMarker) {
            xhrAddMarker = new XMLHttpRequest();

            xhrAddMarker.open('PUT', API_PATH + '/marker', true);
            xhrAddMarker.setRequestHeader('Content-Type', 'application/json');
            xhrAddMarker.onreadystatechange = addMarkerHandleResponse;
            xhrAddMarker.send(JSON.stringify(newMarker));

            // HTTP response handling
            function addMarkerHandleResponse() {
                if (xhrAddMarker.readyState === XMLHttpRequest.DONE) {
                    if (xhrAddMarker.status === 200) {
                        callback();
                    } else {
                        alert('Request "addMarker" failed with code ' + xhrAddMarker.status.toString() + ' :(');
                    }
                }
            }
        }

        function editMarkerRequest(latitude, longitude) {
            xhrEditMarker = new XMLHttpRequest();

            xhrEditMarker.open('POST', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString(), true);
            xhrEditMarker.onreadystatechange = editMarkerHandleResponse;
            xhrEditMarker.send();

            // HTTP response handling
            function editMarkerHandleResponse() {
                if (xhrEditMarker.readyState === XMLHttpRequest.DONE) {
                    if (xhrEditMarker.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "editMarker" failed with code ' + xhrEditMarker.status.toString() + ' :(');
                    }
                }
            }
        }

        function deleteMarkerRequest(callback,latitude, longitude) {
            xhrDeleteMarker = new XMLHttpRequest();

            xhrDeleteMarker.open('DELETE', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString(), true);
            xhrDeleteMarker.onreadystatechange = deleteMarkerHandleResponse;
            xhrDeleteMarker.send();

            // HTTP response handling
            function deleteMarkerHandleResponse() {
                if (xhrDeleteMarker.readyState === XMLHttpRequest.DONE) {
                    if (xhrDeleteMarker.status === 200) {
                        callback();
                    } else {
                        alert('Request "deleteMarker" failed with code ' + xhrDeleteMarker.status.toString() + ' :(');
                    }
                }
            }
        }

        function addPhotoRequest(latitude, longitude) {
            // Use "multipart-form-data" header for photo upload
            // FIXME add content to the formData
            formData = new FormData();

            // Add file to HTTP request
            xhrAddPhoto = new XMLHttpRequest();

            xhrAddPhoto.open('POST', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString() + '/photo', true);
            xhrAddPhoto.onreadystatechange = addPhotoHandleResponse;
            xhrAddPhoto.send(formData);

            // HTTP response handling
            function addPhotoHandleResponse() {
                if (xhrAddPhoto.readyState === XMLHttpRequest.DONE) {
                    if (xhrAddPhoto.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "addPhoto" failed with code ' + xhrAddPhoto.status.toString() + ' :(');
                    }
                }
            }
        }

        function editPhotoRequest(latitude, longitude, photoId) {
            xhrEditPhoto = new XMLHttpRequest();

            xhrEditPhoto.open('POST', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString() + '/photo/' + photoId, true);
            xhrEditPhoto.onreadystatechange = editPhotoHandleResponse;
            xhrEditPhoto.send();

            // HTTP response handling
            function editPhotoHandleResponse() {
                if (xhrEditPhoto.readyState === XMLHttpRequest.DONE) {
                    if (xhrEditPhoto.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "editPhoto" failed with code ' + xhrEditPhoto.status.toString() + ' :(');
                    }
                }
            }
        }

        function deletePhotoRequest() {
            xhrDeletePhoto = new XMLHttpRequest();

            xhrDeletePhoto.open('DELETE', API_PATH + '/marker/' + latitude.toString() + '/' + longitude.toString() + '/photo/' + photoId, true);
            xhrDeletePhoto.onreadystatechange = deletePhotoHandleResponse;
            xhrDeletePhoto.send();

            // HTTP response handling
            function deletePhotoHandleResponse() {
                if (xhrDeletePhoto.readyState === XMLHttpRequest.DONE) {
                    if (xhrDeletePhoto.status === 200) {
                        // No response body expected
                    } else {
                        alert('Request "deletePhoto" failed with code ' + xhrDeletePhoto.status.toString() + ' :(');
                    }
                }
            }
        }

        //----------------------------------------------------------------------------//
        // Web page logic
        //----------------------------------------------------------------------------//
        getAllMarkersRequest();

    </script>
</body>

</html>
